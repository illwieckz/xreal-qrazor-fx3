case `uname -m` in
	"x86_64")
		COMPILER='../../xmap2.x86_64'
		;;
	*)
		COMPILER='../../xmap2.x86'
		;;
esac

if [ ! -f $COMPILER ]; then
        echo "`basename $COMPILER` not found!"
        echo "Did you build XreaL with scons xmap=1?"
        exit 1
fi

FS_BASEPATH='../..'
FS_GAME='base'
GAME='xreal'
COMPILE="$COMPILER -fs_basepath $FS_BASEPATH -fs_game $FS_GAME -game $GAME"

# map_ convention used to prevent possible binary name collision
map_bsp() {
	$COMPILE -v -meta -leaktest $BSPOPTS $MAP
}

map_debugportals() {
	$COMPILE -v -debugportals -meta -leaktest $MAP
}

map_debugsurfaces() {
	$COMPILE -v -debugsurfaces -meta -leaktest $MAP
}

map_fastvis() {
	$COMPILE -vis -fast $VISOPTS $MAP
}

map_vis() {
	$COMPILE -vis $VISOPTS $MAP
}

map_light() {
	$COMPILE -light -v $LIGHTOPTS $MAP 
}

map_scale() {
	$COMPILE -v -scale "$@" $MAP
}

map_package() {
	cd ..
	DATE=`date +%Y%m%d`
	MAP_STRIPPED=`basename $MAP .map`
	PK3NAME=map-$MAP_STRIPPED-$DATE.pk3
	zip $PK3NAME maps/$MAP_STRIPPED.bsp
	zip $PK3NAME maps/$MAP_STRIPPED/*.hdr
	zip $PK3NAME maps/$MAP_STRIPPED/*.png
	zip $PK3NAME levelshot/$MAP_STRIPPED.png
	zip $PK3NAME scripts/$MAP_STRIPPED.arena
}

map_defaultcommand() {
	echo "specify command: -bsp, -fastvis, -vis, -light, -pk3, or -all"
}

case $1 in
	-bsp)
		map_bsp $BSPOPTS;
		;;
		
	-debugportals)
		map_debugportals;
		;;
	
	-debugsurfaces)
		map_debugsurfaces;
		;;

	-fastvis)
		map_fastvis $VISOPTS;
		;;
		
	-vis)
		map_vis $VISOPTS;
		;;

	-light)
		map_light $LIGHTOPTS;
		;;
		
	-pk3)
		map_package $PACKAGEOTPS;
		;;

	-all)
		map_bsp $BSPOPTS;
		map_vis $VISOPTS;
		map_light $LIGHTOPTS;
		;;
	*)
		map_defaultcommand;
		;;
esac

