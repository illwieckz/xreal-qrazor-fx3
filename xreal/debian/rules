#!/usr/bin/make -f
MAKE = scons

PLATFORM=$(shell uname|sed -e s/_.*//|tr '[:upper:]' '[:lower:]')
ARCH=$(shell uname -m | sed -e s/i.86/x86/)

ifeq ($(PLATFORM),linux)
	ifeq ($(ARCH),x86_64)
		ARCH=x86_64
	else
		ARCH=x86 # FIXME don't fall back to x86 for anything
	endif
endif

#export DH_VERBOSE=1

clean:
	dh_testdir
	dh_clean
	$(MAKE) -c
	rm -rf build

install: build
	dh_clean
	dh_installdirs

build:
	# build client, xmap, xmap2, and radiant
	$(MAKE) warnings=1 debug=2 optimize=2 simd=sse smp=0 llvm=0 compatq3a=0 radiant=1 xmap=1 curl=compile dedicated=0 master=0 tremulous=0
	# build server
	$(MAKE) warnings=1 debug=2 optimize=2 simd=sse smp=0 llvm=0 compatq3a=0 radiant=0 xmap=0 curl=compile dedicated=1 master=0 tremulous=0
	touch build

binary-indep: install
# There are no architecture-independent files to be uploaded
# generated by this package.  If there were any they would be
# made here.

binary-arch: install
	# make package directories
	mkdir -p $(CURDIR)/debian/xreal-server/opt/xreal
	mkdir -p $(CURDIR)/debian/xreal-server/usr/bin
	mkdir -p $(CURDIR)/debian/xreal-client/opt/xreal
	mkdir -p $(CURDIR)/debian/xreal-client/usr/bin
	mkdir -p $(CURDIR)/debian/xmap/opt/xreal
	mkdir -p $(CURDIR)/debian/xmap/usr/bin
	mkdir -p $(CURDIR)/debian/xmap2/opt/xreal
	mkdir -p $(CURDIR)/debian/xmap2/usr/bin
	# copy files into directories
	cp $(CURDIR)/xreal $(CURDIR)/debian/xreal-client/opt/xreal/
	cp $(CURDIR)/debian/scripts/xreal $(CURDIR)/debian/xreal-client/usr/bin/
	cp $(CURDIR)/xreal.$(ARCH) $(CURDIR)/debian/xreal-client/opt/xreal/
	cp $(CURDIR)/xrealded $(CURDIR)/debian/xreal-server/opt/xreal/
	cp $(CURDIR)/debian/scripts/xrealded $(CURDIR)/debian/xreal-client/usr/bin/
	cp $(CURDIR)/xrealded.$(ARCH) $(CURDIR)/debian/xreal-server/opt/xreal/
	cp $(CURDIR)/xmap $(CURDIR)/debian/xmap/opt/xreal/
	cp $(CURDIR)/debian/scripts/xmap $(CURDIR)/debian/xreal-client/usr/bin/
	cp $(CURDIR)/xmap.$(ARCH) $(CURDIR)/debian/xmap/opt/xreal/
	cp $(CURDIR)/xmap2 $(CURDIR)/debian/xmap2/opt/xreal/
	cp $(CURDIR)/debian/scripts/xmap2 $(CURDIR)/debian/xreal-client/usr/bin/
	cp $(CURDIR)/xmap2.$(ARCH) $(CURDIR)/debian/xmap2/opt/xreal/

	dh_testdir -a
	dh_testroot -a
#	dh_installdocs -a NEWS
#	dh_installchangelogs -a changelog
	dh_strip -a
	dh_compress -a
	dh_fixperms -a
	dh_installdeb -a
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary: binary-indep binary-arch

.PHONY: binary binary-arch binary-indep clean checkroot
